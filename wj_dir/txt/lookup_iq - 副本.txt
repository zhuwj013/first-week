#! /bin/bash
########################################################################################################################################文件准备
########################################################################################################################################
########################################################################################################################################
iq_data="iq_data.lmu"
####################################################################检查文件是否存在（-f file：文件为一般文件）
if [[ ! -f  "$iq_data" ]]; then
echo "错误：找不到文件 $iq_data"
exit 1
fi
####################################################################检查文件是否可读（-r file：文件可读）
if [[ ! -r "$iq_data" ]]; then
echo "错误：文件 $iq_data 不可读"
exit 1
fi
####################################################################检查文件是否为空（-s file：文件不是空的）
if [[ ! -s "$iq_data" ]]; then
echo "错误：文件 $iq_data 为空"
exit 0
fi
########################################################################################################################################数据提取、存储
########################################################################################################################################
########################################################################################################################################
declare -A iq_x_data
declare -A iq_m_data
declare -A iq_count_data
####################################################################循环读取每一行数据
count_iq=0
while read -r line || [[ -n  "$line" ]]; do
if [[ "$line" =~ \(IQ([0-9]+)\)=(.*) ]]; then
iq="${BASH_REMATCH[1]}"
data="${BASH_REMATCH[2]}"
((count_iq++))
####################################################################分别存储x，m值的数组
x_values=()
m_values=()
count=0
while [[ "$data" =~ M[[:space:]]+([0-9]+)X[[:space:]]+([0-9]+)(.*) ]]; do
m="${BASH_REMATCH[1]}"
x="${BASH_REMATCH[2]}"
data="${BASH_REMATCH[3]}"
((count++))
x_values+=("$x")
m_values+=("$m")
done
#echo "${x_values[*]}"
#echo "${m_values[*]}"
####################################################################分别将x、m值数组转换为字符串存储
iq_count_data["$iq"]="$count"
iq_x_data["$iq"]="${x_values[*]}"
iq_m_data["$iq"]="${m_values[*]}"
fi
#echo "${iq_x_data[$iq]}"
#echo "${iq_m_data[$iq]}"
####################################################################输入数据
done < <(tr '\n' ' ' < iq_data.lmu | sed  's/ *(IQ/\n(IQ/g; s/^[[:space:]]*//; s/,TAP10,\?//g;  /^$/d')
count_iq="$count_iq"
iq_values=($(echo "${!iq_x_data[@]}" | tr ' ' '\n' | sort -n))
####################################################################提取全部IQ值
echo "以下为文件中的全部IQ值："
echo "${iq_values[*]}"
echo ""
echo "共计 "$count_iq"  个IQ值"
echo ""
####################################################################反复输入要查询的IQ值
while true; do
####################################################################&& break: 如果条件为真，则执行break
echo "请输入要查询的IQ值：（输入q可以退出）"
read iq_input
[[ "$iq_input" ==  "q" ]] && break
####################################################################检查iq_input是否在文件中
if grep -q "(IQ${iq_input})=" "$iq_data"; then
########################################################################################################################################
#echo "${iq_x_data[$iq_input]}"
m_dat1="${iq_m_data[$iq_input]}"
x_dat1="${iq_x_data[$iq_input]}"
read -ra  m_dat <<< "$m_dat1"
read -ra x_dat <<< "$x_dat1"
#echo "$m_dat"
#echo "$x_dat"
#echo "${m_dat[@]}"
########################################################################################################################################
echo "以下该IQ值的全部数据："
for i in "${!m_dat[@]}"; do
echo "(${m_dat[i]}, ${x_dat[i]})"
done
########################################################################################################################################
echo "共计 "${iq_count_data[$iq_input]}"  个数据"
echo ""
else
echo "未找到IQ${iq_input}"
fi
done


